<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dream API - Test Console</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
      line-height: 1.5;
    }
    h1 { color: #38bdf8; margin-bottom: 5px; }
    .subtitle { color: #64748b; margin-bottom: 30px; }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      cursor: pointer;
      color: #94a3b8;
      font-weight: 500;
    }
    .tab.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }
    .tab:hover:not(.active) { background: #334155; }
    .card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 {
      margin: 0 0 15px 0;
      color: #f8fafc;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card h2 .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .badge-saas { background: #3b82f6; color: white; }
    .badge-store { background: #8b5cf6; color: white; }
    label { display: block; color: #94a3b8; font-size: 12px; margin-bottom: 5px; font-weight: 500; }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #f1f5f9;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      margin-bottom: 15px;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    textarea { min-height: 80px; resize: vertical; }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      transition: all 0.15s;
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-warning { background: #f59e0b; color: black; }
    .btn-warning:hover { background: #d97706; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: #475569; color: white; }
    .btn-secondary:hover { background: #64748b; }
    .btn-purple { background: #8b5cf6; color: white; }
    .btn-purple:hover { background: #7c3aed; }
    pre {
      background: #020617;
      border: 1px solid #1e293b;
      border-radius: 8px;
      padding: 15px;
      overflow-x: auto;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
    }
    .status {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-success { background: #064e3b; border: 1px solid #10b981; color: #6ee7b7; }
    .status-error { background: #450a0a; border: 1px solid #ef4444; color: #fca5a5; }
    .status-info { background: #172554; border: 1px solid #3b82f6; color: #93c5fd; }
    .status-warning { background: #422006; border: 1px solid #f59e0b; color: #fcd34d; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    @media (max-width: 700px) {
      .grid, .grid-3 { grid-template-columns: 1fr; }
    }
    #clerk-auth { min-height: 50px; }
    .hidden { display: none; }
    .usage-bar {
      background: #334155;
      border-radius: 6px;
      height: 24px;
      overflow: hidden;
      margin: 10px 0;
    }
    .usage-fill {
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      height: 100%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
      font-size: 11px;
      font-weight: 600;
    }
    .usage-fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .usage-fill.danger { background: linear-gradient(90deg, #ef4444, #f87171); }
    .log-entry { border-bottom: 1px solid #1e293b; padding: 8px 0; }
    .log-entry:last-child { border-bottom: none; }
    .log-time { color: #64748b; font-size: 11px; }
    .log-ok { color: #10b981; }
    .log-err { color: #ef4444; }
    .log-info { color: #3b82f6; }
    .product-card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .product-card h4 { margin: 0 0 8px 0; color: #f8fafc; }
    .product-card p { margin: 0; color: #94a3b8; font-size: 13px; }
    .product-price { color: #10b981; font-weight: 600; font-size: 18px; }
    .copy-btn {
      background: none;
      border: 1px solid #334155;
      color: #64748b;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      border-radius: 4px;
    }
    .copy-btn:hover { background: #334155; color: #f1f5f9; }
  </style>
</head>
<body>
  <h1>Dream API Test Console</h1>
  <p class="subtitle">Test your SaaS or Store integration with secure JWT auth</p>

  <!-- Mode Tabs -->
  <div class="tabs">
    <div class="tab active" data-mode="saas" onclick="switchMode('saas')">SaaS Mode</div>
    <div class="tab" data-mode="store" onclick="switchMode('store')">Store Mode</div>
  </div>

  <!-- Config Section -->
  <div class="card">
    <h2>Configuration</h2>
    <div class="grid">
      <div>
        <label>End-User Clerk Publishable Key</label>
        <input type="text" id="clerkKey" placeholder="pk_test_... (from api-multi/.dev.vars)">
      </div>
      <div>
        <label>API Secret Key</label>
        <input type="text" id="secretKey" placeholder="sk_test_... (from your project)">
      </div>
    </div>
    <label>API Base URL</label>
    <input type="text" id="apiUrl" value="https://api-multi.k-c-sheffield012376.workers.dev">
    <div style="display: flex; gap: 10px; align-items: center;">
      <button class="btn-primary" onclick="initClerk()">Initialize Clerk</button>
      <span id="init-status" style="color: #64748b; font-size: 13px;"></span>
    </div>
  </div>

  <!-- Auth Section -->
  <div class="card">
    <h2>1. Authentication</h2>
    <div id="clerk-auth">
      <div class="status status-info">Enter your Clerk key above and click Initialize to sign in</div>
    </div>
    <div id="auth-info" class="hidden">
      <div class="grid">
        <div>
          <label>User ID <button class="copy-btn" onclick="copyText('userId')">Copy</button></label>
          <input type="text" id="userId" readonly>
        </div>
        <div>
          <label>Plan (from JWT)</label>
          <input type="text" id="userPlan" readonly>
        </div>
      </div>
      <label>JWT Token <button class="copy-btn" onclick="copyText('jwtToken')">Copy</button></label>
      <textarea id="jwtToken" readonly rows="3"></textarea>
    </div>
  </div>

  <!-- SaaS Section -->
  <div id="saas-section">
    <div class="card">
      <h2>2. Usage Tracking <span class="badge badge-saas">SaaS</span></h2>
      <div id="usage-placeholder">
        <div class="status status-info">Sign in to test usage tracking</div>
      </div>
      <div id="usage-controls" class="hidden">
        <div class="usage-bar">
          <div class="usage-fill" id="usage-bar-fill" style="width: 0%"></div>
        </div>
        <p id="usage-text" style="text-align: center; color: #94a3b8; margin: 10px 0;">0 / 0 requests</p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-success" onclick="trackUsage()">POST /api/data</button>
          <button class="btn-secondary" onclick="checkUsage()">GET /api/usage</button>
          <button class="btn-danger" onclick="spamUsage()">Spam Until Limit</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>3. Upgrade Flow <span class="badge badge-saas">SaaS</span></h2>
      <div id="checkout-placeholder">
        <div class="status status-info">Sign in to test checkout</div>
      </div>
      <div id="checkout-controls" class="hidden">
        <p style="color: #94a3b8; margin-bottom: 15px;">Hit your limit? Upgrade your plan!</p>
        <button class="btn-warning" onclick="createCheckout('pro')">Upgrade to Pro</button>
        <button class="btn-secondary" onclick="openPortal()">Manage Billing</button>
      </div>
    </div>
  </div>

  <!-- Store Section -->
  <div id="store-section" class="hidden">
    <div class="card">
      <h2>2. Products <span class="badge badge-store">Store</span></h2>
      <button class="btn-purple" onclick="loadProducts()">Load Products</button>
      <div id="products-grid" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;"></div>
    </div>

    <div class="card">
      <h2>3. Shopping Cart <span class="badge badge-store">Store</span></h2>
      <div id="cart-empty" class="status status-info">Your cart is empty. Add products above.</div>
      <div id="cart-items" class="hidden"></div>
      <div id="cart-footer" class="hidden" style="border-top: 1px solid #334155; padding-top: 15px; margin-top: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <span style="color: #94a3b8;">Total:</span>
          <span id="cart-total" style="font-size: 24px; font-weight: 700; color: #10b981;">$0.00</span>
        </div>
        <div class="grid">
          <div>
            <label>Customer Email</label>
            <input type="email" id="cartEmail" placeholder="buyer@example.com">
          </div>
          <div style="display: flex; align-items: flex-end;">
            <button class="btn-purple" onclick="cartCheckout()" style="width: 100%; height: 42px;">Checkout with Stripe</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Response Log -->
  <div class="card">
    <h2>Response Log <button class="btn-secondary" onclick="clearLog()" style="float: right; margin-top: -5px; padding: 6px 12px;">Clear</button></h2>
    <pre id="response-log">Ready to test...\n\nTip: Copy config.example.js to config.js and fill in your keys for auto-load.</pre>
  </div>

  <!-- Load config if exists -->
  <script src="config.js" onerror="console.log('No config.js - using manual input')"></script>
  <script>
    let clerk = null;
    let currentToken = null;
    let currentMode = 'saas';

    // Auto-load config if present
    window.addEventListener('DOMContentLoaded', () => {
      if (window.TEST_CONFIG) {
        document.getElementById('clerkKey').value = window.TEST_CONFIG.clerkPublishableKey || '';
        document.getElementById('secretKey').value = window.TEST_CONFIG.secretKey || '';
        if (window.TEST_CONFIG.apiUrl) {
          document.getElementById('apiUrl').value = window.TEST_CONFIG.apiUrl;
        }
        log('Config loaded from config.js', 'info');
      }
    });

    function switchMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-mode="${mode}"]`).classList.add('active');
      document.getElementById('saas-section').classList.toggle('hidden', mode !== 'saas');
      document.getElementById('store-section').classList.toggle('hidden', mode !== 'store');
      log(`Switched to ${mode.toUpperCase()} mode`, 'info');
    }

    function log(message, type = 'info') {
      const logEl = document.getElementById('response-log');
      const timestamp = new Date().toLocaleTimeString();
      const typeClass = type === 'error' ? 'log-err' : type === 'success' ? 'log-ok' : 'log-info';
      const prefix = type === 'error' ? 'ERR' : type === 'success' ? 'OK' : 'INFO';
      const formatted = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
      logEl.innerHTML = `<div class="log-entry"><span class="log-time">${timestamp}</span> <span class="${typeClass}">[${prefix}]</span> ${formatted}</div>` + logEl.innerHTML;
    }

    function clearLog() {
      document.getElementById('response-log').innerHTML = 'Log cleared...';
    }

    function copyText(id) {
      const el = document.getElementById(id);
      navigator.clipboard.writeText(el.value);
      log('Copied to clipboard!', 'success');
    }

    async function initClerk() {
      const clerkKey = document.getElementById('clerkKey').value.trim();
      if (!clerkKey) {
        alert('Enter your end-user Clerk publishable key first');
        return;
      }

      document.getElementById('init-status').textContent = 'Loading...';

      try {
        log('Initializing Clerk...');

        const { Clerk } = await import('https://cdn.jsdelivr.net/npm/@clerk/clerk-js@5/+esm');
        clerk = new Clerk(clerkKey);
        await clerk.load();

        document.getElementById('init-status').textContent = '';
        document.getElementById('clerk-auth').innerHTML = '<div id="clerk-mount"></div>';

        if (clerk.user) {
          await handleSignedIn();
        } else {
          clerk.mountSignIn(document.getElementById('clerk-mount'), {
            afterSignInUrl: window.location.href,
            afterSignUpUrl: window.location.href,
          });
          log('Clerk loaded - please sign in', 'success');
        }

        clerk.addListener(async ({ user }) => {
          if (user) await handleSignedIn();
        });

      } catch (err) {
        document.getElementById('init-status').textContent = 'Failed';
        log('Clerk init failed: ' + err.message, 'error');
        console.error(err);
      }
    }

    async function handleSignedIn() {
      currentToken = await clerk.session.getToken();

      // Decode JWT payload (for display only)
      const payload = JSON.parse(atob(currentToken.split('.')[1]));
      const plan = payload.publicMetadata?.plan || 'free';
      const pk = payload.publicMetadata?.publishableKey || 'N/A';

      // Update UI
      document.getElementById('clerk-auth').innerHTML = `
        <div class="status status-success">
          Signed in as <strong>${clerk.user.primaryEmailAddress?.emailAddress}</strong>
          <button class="btn-secondary" onclick="signOut()" style="margin-left: auto;">Sign Out</button>
        </div>
      `;

      document.getElementById('auth-info').classList.remove('hidden');
      document.getElementById('userId').value = clerk.user.id;
      document.getElementById('jwtToken').value = currentToken;
      document.getElementById('userPlan').value = `${plan} (pk: ${pk.substring(0, 25)}...)`;

      // Show controls
      document.getElementById('usage-controls').classList.remove('hidden');
      document.getElementById('usage-placeholder').classList.add('hidden');
      document.getElementById('checkout-controls').classList.remove('hidden');
      document.getElementById('checkout-placeholder').classList.add('hidden');

      log(`Signed in: ${clerk.user.id} | Plan: ${plan}`, 'success');

      // Auto-check usage
      await checkUsage();
    }

    async function signOut() {
      await clerk.signOut();
      location.reload();
    }

    async function apiCall(method, endpoint, body = null, needsJwt = true) {
      const apiUrl = document.getElementById('apiUrl').value;
      const secretKey = document.getElementById('secretKey').value;

      if (!secretKey) {
        log('Enter your secret key first', 'error');
        return null;
      }

      if (needsJwt && !currentToken) {
        log('Sign in first to get JWT', 'error');
        return null;
      }

      const headers = {
        'Authorization': `Bearer ${secretKey}`,
        'Content-Type': 'application/json',
      };

      if (needsJwt) {
        headers['X-Clerk-Token'] = currentToken;
      }

      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);

      log(`${method} ${endpoint}`, 'info');

      try {
        const res = await fetch(`${apiUrl}${endpoint}`, options);
        const data = await res.json();

        if (res.ok) {
          log(data, 'success');
        } else {
          log(`${res.status}: ${JSON.stringify(data)}`, 'error');
        }

        return { ok: res.ok, status: res.status, data };
      } catch (err) {
        log('Request failed: ' + err.message, 'error');
        return null;
      }
    }

    // SaaS Functions
    async function trackUsage() {
      const result = await apiCall('POST', '/api/data');
      if (result?.data) updateUsageDisplay(result.data.usage || result.data);
    }

    async function checkUsage() {
      const result = await apiCall('GET', '/api/usage');
      if (result?.data) updateUsageDisplay(result.data);
    }

    async function spamUsage() {
      log('Spamming until limit...', 'info');
      for (let i = 0; i < 20; i++) {
        const result = await apiCall('POST', '/api/data');
        if (!result?.ok) {
          log('Limit reached!', 'error');
          break;
        }
        updateUsageDisplay(result.data.usage || result.data);
        await new Promise(r => setTimeout(r, 200));
      }
    }

    function updateUsageDisplay(usage) {
      if (!usage) return;
      const count = usage.usageCount || usage.count || 0;
      const limit = usage.limit || 0;
      const pct = limit > 0 ? Math.min((count / limit) * 100, 100) : 0;

      const bar = document.getElementById('usage-bar-fill');
      bar.style.width = pct + '%';
      bar.className = 'usage-fill' + (pct >= 100 ? ' danger' : pct >= 80 ? ' warning' : '');
      bar.textContent = pct > 10 ? `${Math.round(pct)}%` : '';

      document.getElementById('usage-text').textContent =
        `${count} / ${limit} requests (${usage.plan || 'unknown'} tier)`;
    }

    async function createCheckout(tier) {
      const result = await apiCall('POST', '/api/create-checkout', { tier });
      if (result?.data?.url) {
        log('Opening Stripe checkout...', 'success');
        window.open(result.data.url, '_blank');
      }
    }

    async function openPortal() {
      const result = await apiCall('POST', '/api/customer-portal');
      if (result?.data?.url) {
        log('Opening billing portal...', 'success');
        window.open(result.data.url, '_blank');
      }
    }

    // Store Functions
    let cart = [];
    let products = [];

    async function loadProducts() {
      const result = await apiCall('GET', '/api/products', null, false);
      if (result?.data?.products) {
        products = result.data.products;
        renderProducts();
      }
    }

    function renderProducts() {
      const container = document.getElementById('products-grid');
      container.innerHTML = products.map((p, idx) => {
        // Parse features if JSON
        let features = [];
        let imageUrl = '';
        let description = '';
        try {
          const f = typeof p.features === 'string' ? JSON.parse(p.features) : p.features;
          features = f?.features || [];
          imageUrl = f?.imageUrl || p.imageUrl || '';
          description = f?.description || p.description || '';
        } catch { }

        const soldOut = p.inventory !== null && p.inventory <= 0;

        return `
          <div class="product-card" style="background: #0f172a; border: 1px solid #334155; border-radius: 12px; overflow: hidden; ${soldOut ? 'opacity: 0.6;' : ''}">
            ${imageUrl ? `<img src="${imageUrl}" style="width: 100%; height: 160px; object-fit: cover;">` : `<div style="width: 100%; height: 160px; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); display: flex; align-items: center; justify-content: center; font-size: 40px;">ðŸ“¦</div>`}
            <div style="padding: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <h4 style="margin: 0; color: #f8fafc; font-size: 16px;">${p.displayName || p.name}</h4>
                ${soldOut ? '<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">SOLD OUT</span>' : ''}
              </div>
              <p style="color: #10b981; font-size: 24px; font-weight: 700; margin: 0 0 8px 0;">$${p.price}</p>
              ${description ? `<p style="color: #94a3b8; font-size: 13px; margin: 0 0 10px 0;">${description}</p>` : ''}
              ${features.length > 0 ? `<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px;">${features.map(f => `<span style="background: #334155; color: #94a3b8; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${f}</span>`).join('')}</div>` : ''}
              ${p.inventory !== null ? `<p style="color: #64748b; font-size: 12px; margin: 0 0 10px 0;">Stock: ${p.inventory}</p>` : ''}
              <div style="display: flex; gap: 8px; align-items: center;">
                <button class="btn-secondary" onclick="changeQty(${idx}, -1)" style="padding: 6px 12px;" ${soldOut ? 'disabled' : ''}>-</button>
                <span id="qty-${idx}" style="min-width: 30px; text-align: center;">1</span>
                <button class="btn-secondary" onclick="changeQty(${idx}, 1)" style="padding: 6px 12px;" ${soldOut ? 'disabled' : ''}>+</button>
                <button class="btn-purple" onclick="addToCart(${idx})" style="flex: 1;" ${soldOut ? 'disabled' : ''}>Add to Cart</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function changeQty(idx, delta) {
      const el = document.getElementById(`qty-${idx}`);
      let qty = parseInt(el.textContent) + delta;
      if (qty < 1) qty = 1;
      if (qty > 99) qty = 99;
      el.textContent = qty;
    }

    function addToCart(idx) {
      const product = products[idx];
      const qty = parseInt(document.getElementById(`qty-${idx}`).textContent);

      const existing = cart.find(item => item.priceId === product.priceId);
      if (existing) {
        existing.quantity += qty;
      } else {
        cart.push({
          priceId: product.priceId,
          name: product.displayName || product.name,
          price: product.price,
          quantity: qty,
        });
      }

      log(`Added ${qty}x ${product.displayName || product.name} to cart`, 'success');
      renderCart();
    }

    function removeFromCart(priceId) {
      cart = cart.filter(item => item.priceId !== priceId);
      renderCart();
    }

    function updateCartQty(priceId, delta) {
      const item = cart.find(i => i.priceId === priceId);
      if (item) {
        item.quantity += delta;
        if (item.quantity < 1) {
          removeFromCart(priceId);
          return;
        }
      }
      renderCart();
    }

    function renderCart() {
      const empty = document.getElementById('cart-empty');
      const items = document.getElementById('cart-items');
      const footer = document.getElementById('cart-footer');

      if (cart.length === 0) {
        empty.classList.remove('hidden');
        items.classList.add('hidden');
        footer.classList.add('hidden');
        return;
      }

      empty.classList.add('hidden');
      items.classList.remove('hidden');
      footer.classList.remove('hidden');

      items.innerHTML = cart.map(item => `
        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: #0f172a; border-radius: 8px; margin-bottom: 10px;">
          <div style="flex: 1;">
            <p style="margin: 0; color: #f8fafc; font-weight: 500;">${item.name}</p>
            <p style="margin: 4px 0 0 0; color: #10b981; font-weight: 600;">$${item.price} each</p>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <button class="btn-secondary" onclick="updateCartQty('${item.priceId}', -1)" style="padding: 4px 10px;">-</button>
            <span style="min-width: 24px; text-align: center;">${item.quantity}</span>
            <button class="btn-secondary" onclick="updateCartQty('${item.priceId}', 1)" style="padding: 4px 10px;">+</button>
          </div>
          <p style="margin: 0; color: #f8fafc; font-weight: 600; min-width: 70px; text-align: right;">$${(item.price * item.quantity).toFixed(2)}</p>
          <button onclick="removeFromCart('${item.priceId}')" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px;">Ã—</button>
        </div>
      `).join('');

      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
    }

    async function cartCheckout() {
      const email = document.getElementById('cartEmail').value;

      if (!email) {
        log('Enter customer email', 'error');
        return;
      }

      if (cart.length === 0) {
        log('Cart is empty', 'error');
        return;
      }

      const items = cart.map(item => ({
        priceId: item.priceId,
        quantity: item.quantity,
      }));

      log(`Checking out ${items.length} item(s)...`, 'info');

      const result = await apiCall('POST', '/api/cart/checkout', {
        email,
        items,
        successUrl: window.location.href + '?success=true',
        cancelUrl: window.location.href + '?canceled=true',
      }, false);

      if (result?.data?.url) {
        log('Opening Stripe checkout...', 'success');
        window.open(result.data.url, '_blank');
      }
    }

    // Check URL params for checkout result
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get('success') === 'true') {
        log('Payment successful! Inventory should be decremented.', 'success');
        cart = [];
        renderCart();
      } else if (params.get('canceled') === 'true') {
        log('Payment canceled.', 'info');
      }
    });
  </script>
</body>
</html>
